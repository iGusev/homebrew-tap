# Homebrew Tap Setup Guide

This document explains how the GLF Homebrew tap is configured and how to set it up for automatic formula updates.

## Overview

This tap is automatically maintained by [GoReleaser](https://goreleaser.com/). When a new release is created in the [glf repository](https://github.com/igusev/glf), GoReleaser automatically:

1. Builds binaries for all platforms
2. Creates GitHub release with artifacts
3. Updates the Homebrew formula in this tap repository
4. Commits and pushes the updated formula

## Prerequisites

### GitHub Personal Access Token

For GoReleaser to push formula updates to this tap repository, you need to create a GitHub Personal Access Token (PAT) with the following permissions:

1. Go to GitHub Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Click "Generate new token (classic)"
3. Name it "HOMEBREW_TAP_GITHUB_TOKEN" or similar
4. Select scopes:
   - `repo` (Full control of private repositories) - includes all repo permissions
5. Generate token and copy it

### Configure GitHub Secret

Add the token as a secret in the main GLF repository:

1. Go to https://github.com/igusev/glf/settings/secrets/actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_GITHUB_TOKEN`
4. Value: Paste your token
5. Click "Add secret"

### Update GitHub Actions Workflow

The `.github/workflows/release.yml` in the glf repository needs to use this token:

```yaml
- name: Run GoReleaser
  uses: goreleaser/goreleaser-action@v6
  with:
    distribution: goreleaser
    version: latest
    args: release --clean
  env:
    GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
```

**Note:** Change `GITHUB_TOKEN` to use the `HOMEBREW_TAP_GITHUB_TOKEN` secret instead of the default token.

## GoReleaser Configuration

The `.goreleaser.yml` file in the glf repository contains the tap configuration:

```yaml
brews:
  - repository:
      owner: igusev
      name: homebrew-tap
      branch: main
    folder: Formula
    homepage: "https://github.com/igusev/glf"
    description: "Fast CLI tool for instant fuzzy search across self-hosted GitLab projects"
    license: "MIT"
    test: |
      system "#{bin}/glf", "--help"
    install: |
      bin.install "glf"
```

## How It Works

### Release Process

1. **Tag a new release** in the glf repository:
   ```bash
   git tag -a v0.3.0 -m "Release v0.3.0"
   git push origin v0.3.0
   ```

2. **GitHub Actions triggers** the release workflow

3. **GoReleaser runs** and performs:
   - Builds binaries for all platforms
   - Creates archives with proper naming
   - Generates checksums
   - Creates GitHub release
   - **Updates Homebrew formula** in this tap

4. **Formula is automatically updated** with:
   - New version number
   - Updated download URLs
   - New SHA256 checksums
   - Automatic commit and push to tap repository

### What Gets Updated

When a new release is created, the `Formula/glf.rb` file is automatically updated with:

```ruby
class Glf < Formula
  desc "Fast CLI tool for instant fuzzy search across self-hosted GitLab projects"
  homepage "https://github.com/igusev/glf"
  version "0.3.0"  # Updated automatically

  on_macos do
    on_intel do
      url "https://github.com/iGusev/glf/releases/download/v0.3.0/..."  # New URL
      sha256 "..."  # New checksum
      # ...
    end
  end
  # ...
end
```

## Testing Locally

Before pushing a new release, you can test the GoReleaser configuration:

```bash
# In the glf repository
cd /path/to/glf

# Test the configuration without publishing
goreleaser release --snapshot --clean

# Validate the configuration
goreleaser check
```

## Manual Formula Update

If you need to manually update the formula (not recommended):

```bash
cd homebrew-tap
# Edit Formula/glf.rb
git add Formula/glf.rb
git commit -m "Update glf formula to v0.3.0"
git push origin main
```

## Troubleshooting

### Formula Not Updated

1. Check GitHub Actions logs in glf repository
2. Verify `HOMEBREW_TAP_GITHUB_TOKEN` is set correctly
3. Ensure token has `repo` scope
4. Check `.goreleaser.yml` configuration

### Permission Denied

- Token doesn't have write access to homebrew-tap repository
- Token expired - regenerate and update secret

### Invalid Formula

```bash
# Test the formula locally
brew install --build-from-source igusev/tap/glf

# Audit the formula
brew audit --strict igusev/tap/glf
```

## Repository Structure

```
homebrew-tap/
├── Formula/
│   └── glf.rb           # Auto-generated by GoReleaser
├── .gitignore
├── LICENSE
├── README.md            # User-facing documentation
└── SETUP.md            # This file - maintainer documentation
```

## Links

- [GoReleaser Documentation](https://goreleaser.com/)
- [Homebrew Tap Documentation](https://docs.brew.sh/Taps)
- [GLF Repository](https://github.com/igusev/glf)
- [How to Create and Maintain a Tap](https://docs.brew.sh/How-to-Create-and-Maintain-a-Tap)

## Security Notes

- Never commit the GitHub token to the repository
- Only store it as a GitHub Actions secret
- Token should have minimal required permissions (`repo` scope only)
- Consider using fine-grained tokens for better security
- Rotate tokens periodically

## Maintenance

This tap requires minimal maintenance as it's fully automated:

- ✅ Formula updates: Automatic via GoReleaser
- ✅ Version bumps: Automatic on new releases
- ✅ Checksum updates: Automatic
- ✅ Binary URLs: Automatic

Manual intervention only needed for:
- Changing formula structure (rare)
- Updating descriptions or metadata
- Troubleshooting release issues
